(()=>{"use strict";const e={minWidth:200,minHeight:200,realThreshold:.5,nsfwThreshold:.5,autoAnalyze:!0,showOverlay:!0},n={x:20,y:20};class t{constructor(){this.imageListEl=null,this.footerEl=null,this.images=[],this.settings={...e},this.modelStatus=null,this.isVisible=!1,this.isDragging=!1,this.dragOffset={x:0,y:0},this.position={...n},this.handleDrag=e=>{this.isDragging&&(this.position={x:Math.max(0,Math.min(window.innerWidth-420,e.clientX-this.dragOffset.x)),y:Math.max(0,Math.min(window.innerHeight-100,e.clientY-this.dragOffset.y))},this.updatePosition())},this.handleDragEnd=()=>{this.isDragging=!1,document.removeEventListener("mousemove",this.handleDrag),document.removeEventListener("mouseup",this.handleDragEnd)},this.container=document.createElement("div"),this.container.id="diffreal-container",this.shadowRoot=this.container.attachShadow({mode:"closed"}),this.panel=document.createElement("div"),this.panel.className="diffreal-panel hidden",this.injectStyles(),this.render(),this.setupDragListeners(),document.body.appendChild(this.container)}injectStyles(){const e=document.createElement("style");e.textContent=":host {\n  all: initial;\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  font-size: 14px;\n  color: #e0e0e0;\n}\n\n.diffreal-panel {\n  position: fixed;\n  z-index: 2147483647;\n  background: rgba(30, 30, 35, 0.95);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 12px;\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n  backdrop-filter: blur(10px);\n  width: 420px;\n  max-height: 80vh;\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n  user-select: none;\n}\n\n.diffreal-panel.hidden {\n  display: none;\n}\n\n.diffreal-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 12px 16px;\n  background: rgba(255, 255, 255, 0.05);\n  cursor: move;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.diffreal-title {\n  font-weight: 600;\n  font-size: 15px;\n  color: #fff;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.diffreal-title-icon {\n  width: 20px;\n  height: 20px;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  border-radius: 4px;\n}\n\n.diffreal-header-buttons {\n  display: flex;\n  gap: 8px;\n}\n\n.diffreal-header-btn {\n  width: 28px;\n  height: 28px;\n  border: none;\n  background: rgba(255, 255, 255, 0.1);\n  border-radius: 6px;\n  cursor: pointer;\n  color: #a0a0a0;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  transition: all 0.2s;\n}\n\n.diffreal-header-btn:hover {\n  background: rgba(255, 255, 255, 0.2);\n  color: #fff;\n}\n\n.diffreal-header-btn.close:hover {\n  background: rgba(255, 80, 80, 0.3);\n  color: #ff6b6b;\n}\n\n.diffreal-controls {\n  padding: 12px 16px;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.diffreal-control-row {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  margin-bottom: 12px;\n}\n\n.diffreal-control-row:last-child {\n  margin-bottom: 0;\n}\n\n.diffreal-control-label {\n  font-size: 12px;\n  color: #a0a0a0;\n  min-width: 80px;\n}\n\n.diffreal-size-inputs {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.diffreal-size-input {\n  width: 60px;\n  padding: 6px 8px;\n  background: rgba(255, 255, 255, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 6px;\n  color: #fff;\n  font-size: 12px;\n  text-align: center;\n}\n\n.diffreal-size-input:focus {\n  outline: none;\n  border-color: #667eea;\n}\n\n.diffreal-threshold-slider {\n  flex: 1;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.diffreal-slider {\n  flex: 1;\n  -webkit-appearance: none;\n  height: 6px;\n  background: rgba(255, 255, 255, 0.2);\n  border-radius: 3px;\n  outline: none;\n}\n\n.diffreal-slider::-webkit-slider-thumb {\n  -webkit-appearance: none;\n  width: 16px;\n  height: 16px;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  border-radius: 50%;\n  cursor: pointer;\n  transition: transform 0.2s;\n}\n\n.diffreal-slider::-webkit-slider-thumb:hover {\n  transform: scale(1.1);\n}\n\n.diffreal-threshold-value {\n  font-size: 12px;\n  color: #667eea;\n  min-width: 32px;\n  text-align: right;\n  font-weight: 600;\n}\n\n.diffreal-image-list {\n  flex: 1;\n  overflow-y: auto;\n  max-height: 400px;\n}\n\n.diffreal-image-list::-webkit-scrollbar {\n  width: 6px;\n}\n\n.diffreal-image-list::-webkit-scrollbar-track {\n  background: transparent;\n}\n\n.diffreal-image-list::-webkit-scrollbar-thumb {\n  background: rgba(255, 255, 255, 0.2);\n  border-radius: 3px;\n}\n\n.diffreal-image-table {\n  width: 100%;\n  border-collapse: collapse;\n}\n\n.diffreal-table-header {\n  position: sticky;\n  top: 0;\n  background: rgba(30, 30, 35, 0.98);\n}\n\n.diffreal-table-header th {\n  padding: 10px 12px;\n  text-align: left;\n  font-size: 11px;\n  font-weight: 600;\n  color: #808080;\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.diffreal-image-row {\n  transition: background 0.2s;\n}\n\n.diffreal-image-row:hover {\n  background: rgba(255, 255, 255, 0.05);\n}\n\n.diffreal-image-row.highlight {\n  background: rgba(102, 126, 234, 0.2);\n}\n\n.diffreal-image-row.filtered {\n  opacity: 0.4;\n}\n\n.diffreal-image-row td {\n  padding: 8px 12px;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n  vertical-align: middle;\n}\n\n.diffreal-thumbnail {\n  width: 40px;\n  height: 40px;\n  object-fit: cover;\n  border-radius: 4px;\n  background: rgba(255, 255, 255, 0.1);\n}\n\n.diffreal-thumbnail-placeholder {\n  width: 40px;\n  height: 40px;\n  border-radius: 4px;\n  background: rgba(255, 255, 255, 0.1);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-size: 8px;\n  color: #888;\n}\n\n.diffreal-score {\n  font-size: 13px;\n  font-weight: 600;\n  padding: 4px 8px;\n  border-radius: 4px;\n  display: inline-block;\n  min-width: 45px;\n  text-align: center;\n}\n\n.diffreal-score.real-high {\n  background: rgba(255, 107, 107, 0.2);\n  color: #ff6b6b;\n}\n\n.diffreal-score.real-medium {\n  background: rgba(255, 193, 7, 0.2);\n  color: #ffc107;\n}\n\n.diffreal-score.real-low {\n  background: rgba(76, 175, 80, 0.2);\n  color: #4caf50;\n}\n\n.diffreal-score.nsfw-high {\n  background: rgba(255, 107, 107, 0.2);\n  color: #ff6b6b;\n}\n\n.diffreal-score.nsfw-medium {\n  background: rgba(255, 193, 7, 0.2);\n  color: #ffc107;\n}\n\n.diffreal-score.nsfw-low {\n  background: rgba(76, 175, 80, 0.2);\n  color: #4caf50;\n}\n\n.diffreal-status {\n  font-size: 11px;\n  padding: 4px 8px;\n  border-radius: 4px;\n}\n\n.diffreal-status.pending {\n  background: rgba(255, 255, 255, 0.1);\n  color: #808080;\n}\n\n.diffreal-status.analyzing {\n  background: rgba(102, 126, 234, 0.2);\n  color: #667eea;\n  animation: pulse 1.5s infinite;\n}\n\n.diffreal-status.complete {\n  background: rgba(76, 175, 80, 0.2);\n  color: #4caf50;\n}\n\n.diffreal-status.error {\n  background: rgba(255, 107, 107, 0.2);\n  color: #ff6b6b;\n}\n\n@keyframes pulse {\n  0%, 100% { opacity: 1; }\n  50% { opacity: 0.5; }\n}\n\n.diffreal-goto-btn {\n  padding: 4px 10px;\n  background: rgba(102, 126, 234, 0.2);\n  border: none;\n  border-radius: 4px;\n  color: #667eea;\n  font-size: 11px;\n  cursor: pointer;\n  transition: all 0.2s;\n}\n\n.diffreal-goto-btn:hover {\n  background: rgba(102, 126, 234, 0.4);\n}\n\n.diffreal-footer {\n  padding: 10px 16px;\n  background: rgba(255, 255, 255, 0.03);\n  border-top: 1px solid rgba(255, 255, 255, 0.1);\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  font-size: 11px;\n  color: #808080;\n}\n\n.diffreal-footer-stat {\n  display: flex;\n  align-items: center;\n  gap: 4px;\n}\n\n.diffreal-footer-stat .value {\n  color: #e0e0e0;\n  font-weight: 600;\n}\n\n.diffreal-model-status {\n  display: flex;\n  gap: 12px;\n}\n\n.diffreal-model-badge {\n  padding: 2px 8px;\n  border-radius: 4px;\n  font-size: 10px;\n  font-weight: 600;\n  text-transform: uppercase;\n}\n\n.diffreal-model-badge.ready {\n  background: rgba(76, 175, 80, 0.2);\n  color: #4caf50;\n}\n\n.diffreal-model-badge.loading {\n  background: rgba(255, 193, 7, 0.2);\n  color: #ffc107;\n  animation: pulse 1.5s infinite;\n}\n\n.diffreal-model-badge.error {\n  background: rgba(255, 107, 107, 0.2);\n  color: #ff6b6b;\n}\n\n.diffreal-empty {\n  padding: 40px 20px;\n  text-align: center;\n  color: #808080;\n}\n\n.diffreal-empty-icon {\n  font-size: 32px;\n  margin-bottom: 12px;\n  opacity: 0.5;\n}\n\n.diffreal-scan-btn {\n  margin-top: 16px;\n  padding: 10px 24px;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  border: none;\n  border-radius: 8px;\n  color: #fff;\n  font-size: 13px;\n  font-weight: 600;\n  cursor: pointer;\n  transition: transform 0.2s, box-shadow 0.2s;\n}\n\n.diffreal-scan-btn:hover {\n  transform: translateY(-1px);\n  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\n}\n\n.diffreal-scan-btn:active {\n  transform: translateY(0);\n}\n\n.diffreal-progress-bar {\n  width: 100%;\n  height: 3px;\n  background: rgba(255, 255, 255, 0.1);\n  border-radius: 2px;\n  overflow: hidden;\n  margin-top: 8px;\n}\n\n.diffreal-progress-fill {\n  height: 100%;\n  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);\n  transition: width 0.3s ease;\n}\n",this.shadowRoot.appendChild(e)}render(){this.panel.innerHTML=`\n      <div class="diffreal-header">\n        <div class="diffreal-title">\n          <div class="diffreal-title-icon"></div>\n          DiffReal\n        </div>\n        <div class="diffreal-header-buttons">\n          <button class="diffreal-header-btn minimize" title="Minimize">âˆ’</button>\n          <button class="diffreal-header-btn close" title="Close">Ã—</button>\n        </div>\n      </div>\n\n      <div class="diffreal-controls">\n        <div class="diffreal-control-row">\n          <button class="diffreal-scan-btn" id="scanBtnMain">Scan Page</button>\n        </div>\n        <div class="diffreal-control-row">\n          <span class="diffreal-control-label">Min Size:</span>\n          <div class="diffreal-size-inputs">\n            <input type="number" class="diffreal-size-input" id="minWidth" value="${this.settings.minWidth}" min="1">\n            <span>Ã—</span>\n            <input type="number" class="diffreal-size-input" id="minHeight" value="${this.settings.minHeight}" min="1">\n            <span>px</span>\n          </div>\n        </div>\n        <div class="diffreal-control-row">\n          <span class="diffreal-control-label">Real Threshold:</span>\n          <div class="diffreal-threshold-slider">\n            <input type="range" class="diffreal-slider" id="realThreshold"\n                   min="0" max="1" step="0.05" value="${this.settings.realThreshold}">\n            <span class="diffreal-threshold-value" id="realThresholdValue">${this.settings.realThreshold.toFixed(2)}</span>\n          </div>\n        </div>\n      </div>\n\n      <div class="diffreal-image-list">\n        <table class="diffreal-image-table">\n          <thead class="diffreal-table-header">\n            <tr>\n              <th style="width: 40px">#</th>\n              <th style="width: 50px">Image</th>\n              <th style="width: 70px">Real</th>\n              <th style="width: 70px">NSFW</th>\n              <th style="width: 80px">Status</th>\n              <th style="width: 60px"></th>\n            </tr>\n          </thead>\n          <tbody id="imageListBody"></tbody>\n        </table>\n        <div class="diffreal-empty" id="emptyState">\n          <div class="diffreal-empty-icon">ðŸ“·</div>\n          <div>No images found</div>\n          <button class="diffreal-scan-btn" id="scanBtn">Scan Page</button>\n        </div>\n      </div>\n\n      <div class="diffreal-footer">\n        <div class="diffreal-footer-stat">\n          Analyzed: <span class="value" id="analyzedCount">0</span>/<span id="totalCount">0</span>\n        </div>\n        <div class="diffreal-model-status">\n          <span class="diffreal-model-badge loading" id="clipStatus">CLIP</span>\n          <span class="diffreal-model-badge loading" id="nsfwStatus">NSFW</span>\n          <span class="diffreal-model-badge" id="gpuStatus">CPU</span>\n        </div>\n      </div>\n    `,this.shadowRoot.appendChild(this.panel),this.imageListEl=this.panel.querySelector("#imageListBody"),this.footerEl=this.panel.querySelector(".diffreal-footer"),this.setupEventListeners(),this.updatePosition()}setupEventListeners(){const e=this.panel.querySelector(".diffreal-header-btn.close");e?.addEventListener("click",()=>this.hide());const n=this.panel.querySelector(".diffreal-header-btn.minimize");n?.addEventListener("click",()=>this.toggleMinimize());const t=this.panel.querySelector("#scanBtn");t?.addEventListener("click",()=>this.onScanRequest?.());const i=this.panel.querySelector("#scanBtnMain");i?.addEventListener("click",()=>this.onScanRequest?.());const a=this.panel.querySelector("#minWidth"),s=this.panel.querySelector("#minHeight"),r=this.panel.querySelector("#realThreshold");a?.addEventListener("change",()=>{this.onSettingsChange?.({minWidth:parseInt(a.value,10)||512})}),s?.addEventListener("change",()=>{this.onSettingsChange?.({minHeight:parseInt(s.value,10)||512})}),r?.addEventListener("input",()=>{const e=parseFloat(r.value),n=this.panel.querySelector("#realThresholdValue");n&&(n.textContent=e.toFixed(2)),this.onSettingsChange?.({realThreshold:e}),this.updateImageList()})}setupDragListeners(){const e=this.panel.querySelector(".diffreal-header");e?.addEventListener("mousedown",e=>{e.target.closest(".diffreal-header-btn")||(this.isDragging=!0,this.dragOffset={x:e.clientX-this.position.x,y:e.clientY-this.position.y},document.addEventListener("mousemove",this.handleDrag),document.addEventListener("mouseup",this.handleDragEnd))})}updatePosition(){this.panel.style.left=`${this.position.x}px`,this.panel.style.top=`${this.position.y}px`}toggleMinimize(){const e=this.panel.querySelector(".diffreal-controls"),n=this.panel.querySelector(".diffreal-image-list"),t=this.panel.querySelector(".diffreal-footer"),i="none"===e.style.display;e.style.display=i?"":"none",n.style.display=i?"":"none",t.style.display=i?"":"none"}show(){this.isVisible=!0,this.panel.classList.remove("hidden")}hide(){this.isVisible=!1,this.panel.classList.add("hidden")}toggle(){this.isVisible?this.hide():this.show()}isShown(){return this.isVisible}setImages(e){this.images=e,this.updateImageList(),this.updateFooter()}updateImage(e,n){const t=this.images.findIndex(n=>n.id===e);-1!==t&&(this.images[t]={...this.images[t],...n},this.updateImageRow(e),this.updateFooter())}setSettings(e){this.settings=e,this.updateSettingsUI(),this.updateImageList()}setModelStatus(e){this.modelStatus=e,this.updateModelStatusUI()}updateSettingsUI(){const e=this.panel.querySelector("#minWidth"),n=this.panel.querySelector("#minHeight"),t=this.panel.querySelector("#realThreshold"),i=this.panel.querySelector("#realThresholdValue");e&&(e.value=String(this.settings.minWidth)),n&&(n.value=String(this.settings.minHeight)),t&&(t.value=String(this.settings.realThreshold)),i&&(i.textContent=this.settings.realThreshold.toFixed(2))}updateImageList(){if(!this.imageListEl)return;const e=this.panel.querySelector("#emptyState");if(0===this.images.length)return this.imageListEl.innerHTML="",void(e&&(e.style.display=""));e&&(e.style.display="none"),this.imageListEl.innerHTML=this.images.map((e,n)=>this.renderImageRow(e,n)).join(""),this.imageListEl.querySelectorAll(".diffreal-goto-btn").forEach(e=>{e.addEventListener("click",()=>{const n=e.dataset.imageId;n&&this.onImageClick?.(n)})})}renderImageRow(e,n){const t=e.analysis&&e.analysis.realScore<this.settings.realThreshold,i=this.getScoreClass(e.analysis?.realScore,"real"),a=this.getScoreClass(e.analysis?.nsfwScore,"nsfw"),s=`<div class="diffreal-thumbnail-placeholder">${e.width}Ã—${e.height}</div>`;return`\n      <tr class="diffreal-image-row ${t?"filtered":""}" data-image-id="${e.id}">\n        <td>${n+1}</td>\n        <td>${s}</td>\n        <td>\n          ${e.analysis?`<span class="diffreal-score ${i}">${e.analysis.realScore.toFixed(2)}</span>`:"-"}\n        </td>\n        <td>\n          ${e.analysis?`<span class="diffreal-score ${a}">${e.analysis.nsfwScore.toFixed(2)}</span>`:"-"}\n        </td>\n        <td>\n          <span class="diffreal-status ${e.status}">${e.status}</span>\n        </td>\n        <td>\n          <button class="diffreal-goto-btn" data-image-id="${e.id}">Go</button>\n        </td>\n      </tr>\n    `}updateImageRow(e){const n=this.imageListEl?.querySelector(`[data-image-id="${e}"]`);if(!n)return;const t=this.images.find(n=>n.id===e);if(!t)return;const i=this.images.indexOf(t);n.outerHTML=this.renderImageRow(t,i);const a=this.imageListEl?.querySelector(`[data-image-id="${e}"]`);a?.querySelector(".diffreal-goto-btn")?.addEventListener("click",()=>{this.onImageClick?.(e)})}getScoreClass(e,n){return void 0===e?"":"real"===n?e>=.7?"real-high":e>=.4?"real-medium":"real-low":e>=.7?"nsfw-high":e>=.3?"nsfw-medium":"nsfw-low"}updateFooter(){const e=this.panel.querySelector("#analyzedCount"),n=this.panel.querySelector("#totalCount"),t=this.images.filter(e=>"complete"===e.status).length;e&&(e.textContent=String(t)),n&&(n.textContent=String(this.images.length))}updateModelStatusUI(){if(!this.modelStatus)return;const e=this.panel.querySelector("#clipStatus"),n=this.panel.querySelector("#nsfwStatus"),t=this.panel.querySelector("#gpuStatus");e&&(e.className=`diffreal-model-badge ${this.modelStatus.clip}`,"loading"===this.modelStatus.clip?e.textContent=`CLIP ${this.modelStatus.clipProgress}%`:e.textContent="CLIP"),n&&(n.className=`diffreal-model-badge ${this.modelStatus.nsfw}`,"loading"===this.modelStatus.nsfw?n.textContent=`NSFW ${this.modelStatus.nsfwProgress}%`:n.textContent="NSFW"),t&&(t.textContent=this.modelStatus.gpuBackend.toUpperCase(),t.className="diffreal-model-badge ready")}onSettings(e){this.onSettingsChange=e}onScan(e){this.onScanRequest=e}onImageSelect(e){this.onImageClick=e}setStatus(e){const n=this.panel.querySelector("#analyzedCount");n&&(n.textContent=e)}destroy(){this.container.remove()}}let i=0;function a(){return"diffreal-img-"+ ++i}const s=new Map;function r(e,n){const t=Math.max(0,e.top),i=Math.min(n,e.bottom)-t;return i>0&&i>=.5*e.height}async function o(e){const n=s.get(e.id);if(n)return n;if(!e.element)throw new Error("No element to capture");const t=await async function(e){e.scrollIntoView({behavior:"instant",block:"center",inline:"center"}),await l(150);const n=e.getBoundingClientRect();if(n.width<=0||n.height<=0)return null;const t=window.innerWidth,i=window.innerHeight,a={x:Math.max(0,n.x),y:Math.max(0,n.y),width:Math.min(n.width,t-Math.max(0,n.x)),height:Math.min(n.height,i-Math.max(0,n.y))};if(a.width<=0||a.height<=0)return null;const s=await chrome.runtime.sendMessage({type:"CAPTURE_SCREEN"});if(!s?.dataUrl)return null;const r=await chrome.runtime.sendMessage({type:"CROP_IMAGE",payload:{screenshot:s.dataUrl,rect:a,devicePixelRatio:window.devicePixelRatio||1}});return r?.dataUrl||null}(e.element);if(t)return s.set(e.id,t),t;throw new Error("Failed to capture image")}function l(e){return new Promise(n=>setTimeout(n,e))}console.log("[DiffReal] Content script loaded");let d=null,c={...e},h=[],f=!1,g=[];async function p(){d=new t,d.onSettings(u),d.onScan(m),d.onImageSelect(b),c=await chrome.runtime.sendMessage({type:"GET_SETTINGS"})||c,d.setSettings(c);const e=await chrome.runtime.sendMessage({type:"GET_MODEL_STATUS"});e&&d.setModelStatus(e),await chrome.runtime.sendMessage({type:"INIT_MODELS"}),new MutationObserver(x).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","style","class"]})}function u(e){c={...c,...e},chrome.runtime.sendMessage({type:"UPDATE_SETTINGS",payload:e}),void 0===e.minWidth&&void 0===e.minHeight||m()}async function m(){s.clear();const e=function(e){const n=[],{minWidth:t,minHeight:i}=e,s=document.querySelectorAll("img");for(const e of s)if(e.naturalWidth>=t&&e.naturalHeight>=i){const t=e.src||e.currentSrc||"";t.startsWith("data:image/svg")||n.push({id:a(),src:t.substring(0,100),width:e.naturalWidth,height:e.naturalHeight,element:e,type:"img"})}const r=document.querySelectorAll("canvas");for(const e of r)e.width>=t&&e.height>=i&&n.push({id:a(),src:"[canvas]",width:e.width,height:e.height,element:e,type:"canvas"});return n}(c);h=e.map(e=>({...e,status:"pending"})),d?.setImages(h),h.length>0&&(d?.setStatus("Capturing images..."),await async function(e){if(0===e.length)return;const n=e.filter(e=>!s.has(e.id));if(0===n.length)return;console.log(`[DiffReal] Capturing ${n.length} images with auto-scroll`);const t=window.scrollY;window.scrollTo(0,0),await l(200);const i=window.innerHeight,a=document.documentElement.scrollHeight;let o=0;for(;o<a;){const e=await chrome.runtime.sendMessage({type:"CAPTURE_SCREEN"});if(e?.dataUrl)for(const t of n){if(s.has(t.id))continue;if(!t.element)continue;const n=t.element.getBoundingClientRect();if(r(n,i)){const a=await chrome.runtime.sendMessage({type:"CROP_IMAGE",payload:{screenshot:e.dataUrl,rect:{x:Math.max(0,n.x),y:Math.max(0,n.y),width:Math.min(n.width,window.innerWidth-Math.max(0,n.x)),height:Math.min(n.height,i-Math.max(0,n.y))},devicePixelRatio:window.devicePixelRatio||1}});a?.dataUrl&&(s.set(t.id,a.dataUrl),console.log(`[DiffReal] Captured: ${t.id}`))}}if(0===n.filter(e=>!s.has(e.id)).length)break;o+=.8*i,window.scrollTo(0,o),await l(150)}window.scrollTo(0,t),console.log(`[DiffReal] Capture complete. Total: ${s.size}/${e.length}`)}(h),d?.setStatus("Analyzing..."),async function(){f||(f=!0,g=h.filter(e=>"pending"===e.status).map(e=>e.id),await async function(){for(;g.length>0;){const e=g.splice(0,5);await Promise.all(e.map(async e=>{const n=h.find(n=>n.id===e);if(n)try{n.status="analyzing",d?.updateImage(e,{status:"analyzing"});const t=await o(n),i=await chrome.runtime.sendMessage({type:"ANALYZE_IMAGE",payload:{imageId:e,imageData:t},target:"offscreen"});if(!i||"error"in i)throw new Error(i?.error||"Analysis failed");y(i)}catch(t){const i=t instanceof Error?t.message:"Unknown error";n.status="error",n.error=i,d?.updateImage(e,{status:"error",error:i})}})),g.length>0&&await new Promise(e=>setTimeout(e,100))}}(),f=!1)}())}function b(e){const n=h.find(n=>n.id===e);if(n?.element){!function(e){if(!e)return;e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"});const n=e.style.outline,t=e.style.transition;e.style.transition="outline 0.3s ease",e.style.outline="4px solid #ff6b6b",setTimeout(()=>{e.style.outline=n,setTimeout(()=>{e.style.transition=t},300)},2e3)}(n.element);const t=document.querySelector(`[data-image-id="${e}"]`);t?.classList.add("highlight"),setTimeout(()=>t?.classList.remove("highlight"),2e3)}}function x(e){let n=!1;for(const t of e)if("childList"===t.type)for(const e of t.addedNodes){if(e instanceof HTMLImageElement){n=!0;break}if(e instanceof HTMLElement&&e.querySelector("img")){n=!0;break}}n&&c.autoAnalyze&&d?.isShown()&&setTimeout(()=>m(),500)}function y(e){const n=h.find(n=>n.id===e.imageId);n&&(n.status="complete",n.analysis=e,d?.updateImage(e.imageId,{status:"complete",analysis:e}))}chrome.runtime.onMessage.addListener((e,n,t)=>(async function(e){switch(e.type){case"TOGGLE_PANEL":const n=e.payload;return void 0!==n?.show?n.show?d?.show():d?.hide():d?.toggle(),d?.isShown();case"MODEL_PROGRESS":case"MODEL_STATUS":return void d?.setModelStatus(e.payload);case"UPDATE_SETTINGS":return c=e.payload,void d?.setSettings(c);case"ANALYSIS_RESULT":return void y(e.payload);default:return}}(e).then(t),!0)),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",p):p()})();