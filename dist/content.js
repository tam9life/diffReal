(()=>{"use strict";const n={minWidth:512,minHeight:512,realThreshold:.5,nsfwThreshold:.5,autoAnalyze:!0,showOverlay:!0},e={x:20,y:20};class t{constructor(){this.imageListEl=null,this.footerEl=null,this.images=[],this.settings={...n},this.modelStatus=null,this.isVisible=!1,this.isDragging=!1,this.dragOffset={x:0,y:0},this.position={...e},this.handleDrag=n=>{this.isDragging&&(this.position={x:Math.max(0,Math.min(window.innerWidth-420,n.clientX-this.dragOffset.x)),y:Math.max(0,Math.min(window.innerHeight-100,n.clientY-this.dragOffset.y))},this.updatePosition())},this.handleDragEnd=()=>{this.isDragging=!1,document.removeEventListener("mousemove",this.handleDrag),document.removeEventListener("mouseup",this.handleDragEnd)},this.container=document.createElement("div"),this.container.id="diffreal-container",this.shadowRoot=this.container.attachShadow({mode:"closed"}),this.panel=document.createElement("div"),this.panel.className="diffreal-panel hidden",this.injectStyles(),this.render(),this.setupDragListeners(),document.body.appendChild(this.container)}injectStyles(){const n=document.createElement("style");n.textContent=":host {\n  all: initial;\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  font-size: 14px;\n  color: #e0e0e0;\n}\n\n.diffreal-panel {\n  position: fixed;\n  z-index: 2147483647;\n  background: rgba(30, 30, 35, 0.95);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 12px;\n  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n  backdrop-filter: blur(10px);\n  width: 420px;\n  max-height: 80vh;\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n  user-select: none;\n}\n\n.diffreal-panel.hidden {\n  display: none;\n}\n\n.diffreal-header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  padding: 12px 16px;\n  background: rgba(255, 255, 255, 0.05);\n  cursor: move;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.diffreal-title {\n  font-weight: 600;\n  font-size: 15px;\n  color: #fff;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.diffreal-title-icon {\n  width: 20px;\n  height: 20px;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  border-radius: 4px;\n}\n\n.diffreal-header-buttons {\n  display: flex;\n  gap: 8px;\n}\n\n.diffreal-header-btn {\n  width: 28px;\n  height: 28px;\n  border: none;\n  background: rgba(255, 255, 255, 0.1);\n  border-radius: 6px;\n  cursor: pointer;\n  color: #a0a0a0;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  transition: all 0.2s;\n}\n\n.diffreal-header-btn:hover {\n  background: rgba(255, 255, 255, 0.2);\n  color: #fff;\n}\n\n.diffreal-header-btn.close:hover {\n  background: rgba(255, 80, 80, 0.3);\n  color: #ff6b6b;\n}\n\n.diffreal-controls {\n  padding: 12px 16px;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.diffreal-control-row {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n  margin-bottom: 12px;\n}\n\n.diffreal-control-row:last-child {\n  margin-bottom: 0;\n}\n\n.diffreal-control-label {\n  font-size: 12px;\n  color: #a0a0a0;\n  min-width: 80px;\n}\n\n.diffreal-size-inputs {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.diffreal-size-input {\n  width: 60px;\n  padding: 6px 8px;\n  background: rgba(255, 255, 255, 0.1);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 6px;\n  color: #fff;\n  font-size: 12px;\n  text-align: center;\n}\n\n.diffreal-size-input:focus {\n  outline: none;\n  border-color: #667eea;\n}\n\n.diffreal-threshold-slider {\n  flex: 1;\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n.diffreal-slider {\n  flex: 1;\n  -webkit-appearance: none;\n  height: 6px;\n  background: rgba(255, 255, 255, 0.2);\n  border-radius: 3px;\n  outline: none;\n}\n\n.diffreal-slider::-webkit-slider-thumb {\n  -webkit-appearance: none;\n  width: 16px;\n  height: 16px;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  border-radius: 50%;\n  cursor: pointer;\n  transition: transform 0.2s;\n}\n\n.diffreal-slider::-webkit-slider-thumb:hover {\n  transform: scale(1.1);\n}\n\n.diffreal-threshold-value {\n  font-size: 12px;\n  color: #667eea;\n  min-width: 32px;\n  text-align: right;\n  font-weight: 600;\n}\n\n.diffreal-image-list {\n  flex: 1;\n  overflow-y: auto;\n  max-height: 400px;\n}\n\n.diffreal-image-list::-webkit-scrollbar {\n  width: 6px;\n}\n\n.diffreal-image-list::-webkit-scrollbar-track {\n  background: transparent;\n}\n\n.diffreal-image-list::-webkit-scrollbar-thumb {\n  background: rgba(255, 255, 255, 0.2);\n  border-radius: 3px;\n}\n\n.diffreal-image-table {\n  width: 100%;\n  border-collapse: collapse;\n}\n\n.diffreal-table-header {\n  position: sticky;\n  top: 0;\n  background: rgba(30, 30, 35, 0.98);\n}\n\n.diffreal-table-header th {\n  padding: 10px 12px;\n  text-align: left;\n  font-size: 11px;\n  font-weight: 600;\n  color: #808080;\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.diffreal-image-row {\n  transition: background 0.2s;\n}\n\n.diffreal-image-row:hover {\n  background: rgba(255, 255, 255, 0.05);\n}\n\n.diffreal-image-row.highlight {\n  background: rgba(102, 126, 234, 0.2);\n}\n\n.diffreal-image-row.filtered {\n  opacity: 0.4;\n}\n\n.diffreal-image-row td {\n  padding: 8px 12px;\n  border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n  vertical-align: middle;\n}\n\n.diffreal-thumbnail {\n  width: 40px;\n  height: 40px;\n  object-fit: cover;\n  border-radius: 4px;\n  background: rgba(255, 255, 255, 0.1);\n}\n\n.diffreal-score {\n  font-size: 13px;\n  font-weight: 600;\n  padding: 4px 8px;\n  border-radius: 4px;\n  display: inline-block;\n  min-width: 45px;\n  text-align: center;\n}\n\n.diffreal-score.real-high {\n  background: rgba(255, 107, 107, 0.2);\n  color: #ff6b6b;\n}\n\n.diffreal-score.real-medium {\n  background: rgba(255, 193, 7, 0.2);\n  color: #ffc107;\n}\n\n.diffreal-score.real-low {\n  background: rgba(76, 175, 80, 0.2);\n  color: #4caf50;\n}\n\n.diffreal-score.nsfw-high {\n  background: rgba(255, 107, 107, 0.2);\n  color: #ff6b6b;\n}\n\n.diffreal-score.nsfw-medium {\n  background: rgba(255, 193, 7, 0.2);\n  color: #ffc107;\n}\n\n.diffreal-score.nsfw-low {\n  background: rgba(76, 175, 80, 0.2);\n  color: #4caf50;\n}\n\n.diffreal-status {\n  font-size: 11px;\n  padding: 4px 8px;\n  border-radius: 4px;\n}\n\n.diffreal-status.pending {\n  background: rgba(255, 255, 255, 0.1);\n  color: #808080;\n}\n\n.diffreal-status.analyzing {\n  background: rgba(102, 126, 234, 0.2);\n  color: #667eea;\n  animation: pulse 1.5s infinite;\n}\n\n.diffreal-status.complete {\n  background: rgba(76, 175, 80, 0.2);\n  color: #4caf50;\n}\n\n.diffreal-status.error {\n  background: rgba(255, 107, 107, 0.2);\n  color: #ff6b6b;\n}\n\n@keyframes pulse {\n  0%, 100% { opacity: 1; }\n  50% { opacity: 0.5; }\n}\n\n.diffreal-goto-btn {\n  padding: 4px 10px;\n  background: rgba(102, 126, 234, 0.2);\n  border: none;\n  border-radius: 4px;\n  color: #667eea;\n  font-size: 11px;\n  cursor: pointer;\n  transition: all 0.2s;\n}\n\n.diffreal-goto-btn:hover {\n  background: rgba(102, 126, 234, 0.4);\n}\n\n.diffreal-footer {\n  padding: 10px 16px;\n  background: rgba(255, 255, 255, 0.03);\n  border-top: 1px solid rgba(255, 255, 255, 0.1);\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  font-size: 11px;\n  color: #808080;\n}\n\n.diffreal-footer-stat {\n  display: flex;\n  align-items: center;\n  gap: 4px;\n}\n\n.diffreal-footer-stat .value {\n  color: #e0e0e0;\n  font-weight: 600;\n}\n\n.diffreal-model-status {\n  display: flex;\n  gap: 12px;\n}\n\n.diffreal-model-badge {\n  padding: 2px 8px;\n  border-radius: 4px;\n  font-size: 10px;\n  font-weight: 600;\n  text-transform: uppercase;\n}\n\n.diffreal-model-badge.ready {\n  background: rgba(76, 175, 80, 0.2);\n  color: #4caf50;\n}\n\n.diffreal-model-badge.loading {\n  background: rgba(255, 193, 7, 0.2);\n  color: #ffc107;\n  animation: pulse 1.5s infinite;\n}\n\n.diffreal-model-badge.error {\n  background: rgba(255, 107, 107, 0.2);\n  color: #ff6b6b;\n}\n\n.diffreal-empty {\n  padding: 40px 20px;\n  text-align: center;\n  color: #808080;\n}\n\n.diffreal-empty-icon {\n  font-size: 32px;\n  margin-bottom: 12px;\n  opacity: 0.5;\n}\n\n.diffreal-scan-btn {\n  margin-top: 16px;\n  padding: 10px 24px;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  border: none;\n  border-radius: 8px;\n  color: #fff;\n  font-size: 13px;\n  font-weight: 600;\n  cursor: pointer;\n  transition: transform 0.2s, box-shadow 0.2s;\n}\n\n.diffreal-scan-btn:hover {\n  transform: translateY(-1px);\n  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\n}\n\n.diffreal-scan-btn:active {\n  transform: translateY(0);\n}\n\n.diffreal-progress-bar {\n  width: 100%;\n  height: 3px;\n  background: rgba(255, 255, 255, 0.1);\n  border-radius: 2px;\n  overflow: hidden;\n  margin-top: 8px;\n}\n\n.diffreal-progress-fill {\n  height: 100%;\n  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);\n  transition: width 0.3s ease;\n}\n",this.shadowRoot.appendChild(n)}render(){this.panel.innerHTML=`\n      <div class="diffreal-header">\n        <div class="diffreal-title">\n          <div class="diffreal-title-icon"></div>\n          DiffReal\n        </div>\n        <div class="diffreal-header-buttons">\n          <button class="diffreal-header-btn minimize" title="Minimize">âˆ’</button>\n          <button class="diffreal-header-btn close" title="Close">Ã—</button>\n        </div>\n      </div>\n\n      <div class="diffreal-controls">\n        <div class="diffreal-control-row">\n          <span class="diffreal-control-label">Min Size:</span>\n          <div class="diffreal-size-inputs">\n            <input type="number" class="diffreal-size-input" id="minWidth" value="${this.settings.minWidth}" min="1">\n            <span>Ã—</span>\n            <input type="number" class="diffreal-size-input" id="minHeight" value="${this.settings.minHeight}" min="1">\n            <span>px</span>\n          </div>\n        </div>\n        <div class="diffreal-control-row">\n          <span class="diffreal-control-label">Real Threshold:</span>\n          <div class="diffreal-threshold-slider">\n            <input type="range" class="diffreal-slider" id="realThreshold"\n                   min="0" max="1" step="0.05" value="${this.settings.realThreshold}">\n            <span class="diffreal-threshold-value" id="realThresholdValue">${this.settings.realThreshold.toFixed(2)}</span>\n          </div>\n        </div>\n      </div>\n\n      <div class="diffreal-image-list">\n        <table class="diffreal-image-table">\n          <thead class="diffreal-table-header">\n            <tr>\n              <th style="width: 40px">#</th>\n              <th style="width: 50px">Image</th>\n              <th style="width: 70px">Real</th>\n              <th style="width: 70px">NSFW</th>\n              <th style="width: 80px">Status</th>\n              <th style="width: 60px"></th>\n            </tr>\n          </thead>\n          <tbody id="imageListBody"></tbody>\n        </table>\n        <div class="diffreal-empty" id="emptyState">\n          <div class="diffreal-empty-icon">ðŸ“·</div>\n          <div>No images found</div>\n          <button class="diffreal-scan-btn" id="scanBtn">Scan Page</button>\n        </div>\n      </div>\n\n      <div class="diffreal-footer">\n        <div class="diffreal-footer-stat">\n          Analyzed: <span class="value" id="analyzedCount">0</span>/<span id="totalCount">0</span>\n        </div>\n        <div class="diffreal-model-status">\n          <span class="diffreal-model-badge loading" id="clipStatus">CLIP</span>\n          <span class="diffreal-model-badge loading" id="nsfwStatus">NSFW</span>\n          <span class="diffreal-model-badge" id="gpuStatus">CPU</span>\n        </div>\n      </div>\n    `,this.shadowRoot.appendChild(this.panel),this.imageListEl=this.panel.querySelector("#imageListBody"),this.footerEl=this.panel.querySelector(".diffreal-footer"),this.setupEventListeners(),this.updatePosition()}setupEventListeners(){const n=this.panel.querySelector(".diffreal-header-btn.close");n?.addEventListener("click",()=>this.hide());const e=this.panel.querySelector(".diffreal-header-btn.minimize");e?.addEventListener("click",()=>this.toggleMinimize());const t=this.panel.querySelector("#scanBtn");t?.addEventListener("click",()=>this.onScanRequest?.());const i=this.panel.querySelector("#minWidth"),a=this.panel.querySelector("#minHeight"),s=this.panel.querySelector("#realThreshold");i?.addEventListener("change",()=>{this.onSettingsChange?.({minWidth:parseInt(i.value,10)||512})}),a?.addEventListener("change",()=>{this.onSettingsChange?.({minHeight:parseInt(a.value,10)||512})}),s?.addEventListener("input",()=>{const n=parseFloat(s.value),e=this.panel.querySelector("#realThresholdValue");e&&(e.textContent=n.toFixed(2)),this.onSettingsChange?.({realThreshold:n}),this.updateImageList()})}setupDragListeners(){const n=this.panel.querySelector(".diffreal-header");n?.addEventListener("mousedown",n=>{n.target.closest(".diffreal-header-btn")||(this.isDragging=!0,this.dragOffset={x:n.clientX-this.position.x,y:n.clientY-this.position.y},document.addEventListener("mousemove",this.handleDrag),document.addEventListener("mouseup",this.handleDragEnd))})}updatePosition(){this.panel.style.left=`${this.position.x}px`,this.panel.style.top=`${this.position.y}px`}toggleMinimize(){const n=this.panel.querySelector(".diffreal-controls"),e=this.panel.querySelector(".diffreal-image-list"),t=this.panel.querySelector(".diffreal-footer"),i="none"===n.style.display;n.style.display=i?"":"none",e.style.display=i?"":"none",t.style.display=i?"":"none"}show(){this.isVisible=!0,this.panel.classList.remove("hidden")}hide(){this.isVisible=!1,this.panel.classList.add("hidden")}toggle(){this.isVisible?this.hide():this.show()}isShown(){return this.isVisible}setImages(n){this.images=n,this.updateImageList(),this.updateFooter()}updateImage(n,e){const t=this.images.findIndex(e=>e.id===n);-1!==t&&(this.images[t]={...this.images[t],...e},this.updateImageRow(n),this.updateFooter())}setSettings(n){this.settings=n,this.updateSettingsUI(),this.updateImageList()}setModelStatus(n){this.modelStatus=n,this.updateModelStatusUI()}updateSettingsUI(){const n=this.panel.querySelector("#minWidth"),e=this.panel.querySelector("#minHeight"),t=this.panel.querySelector("#realThreshold"),i=this.panel.querySelector("#realThresholdValue");n&&(n.value=String(this.settings.minWidth)),e&&(e.value=String(this.settings.minHeight)),t&&(t.value=String(this.settings.realThreshold)),i&&(i.textContent=this.settings.realThreshold.toFixed(2))}updateImageList(){if(!this.imageListEl)return;const n=this.panel.querySelector("#emptyState");if(0===this.images.length)return this.imageListEl.innerHTML="",void(n&&(n.style.display=""));n&&(n.style.display="none"),this.imageListEl.innerHTML=this.images.map((n,e)=>this.renderImageRow(n,e)).join(""),this.imageListEl.querySelectorAll(".diffreal-goto-btn").forEach(n=>{n.addEventListener("click",()=>{const e=n.dataset.imageId;e&&this.onImageClick?.(e)})})}renderImageRow(n,e){const t=n.analysis&&n.analysis.realScore<this.settings.realThreshold,i=this.getScoreClass(n.analysis?.realScore,"real"),a=this.getScoreClass(n.analysis?.nsfwScore,"nsfw");return`\n      <tr class="diffreal-image-row ${t?"filtered":""}" data-image-id="${n.id}">\n        <td>${e+1}</td>\n        <td>\n          <img class="diffreal-thumbnail" src="${n.src}" alt="" loading="lazy">\n        </td>\n        <td>\n          ${n.analysis?`<span class="diffreal-score ${i}">${n.analysis.realScore.toFixed(2)}</span>`:"-"}\n        </td>\n        <td>\n          ${n.analysis?`<span class="diffreal-score ${a}">${n.analysis.nsfwScore.toFixed(2)}</span>`:"-"}\n        </td>\n        <td>\n          <span class="diffreal-status ${n.status}">${n.status}</span>\n        </td>\n        <td>\n          <button class="diffreal-goto-btn" data-image-id="${n.id}">Go</button>\n        </td>\n      </tr>\n    `}updateImageRow(n){const e=this.imageListEl?.querySelector(`[data-image-id="${n}"]`);if(!e)return;const t=this.images.find(e=>e.id===n);if(!t)return;const i=this.images.indexOf(t);e.outerHTML=this.renderImageRow(t,i);const a=this.imageListEl?.querySelector(`[data-image-id="${n}"]`);a?.querySelector(".diffreal-goto-btn")?.addEventListener("click",()=>{this.onImageClick?.(n)})}getScoreClass(n,e){return void 0===n?"":"real"===e?n>=.7?"real-high":n>=.4?"real-medium":"real-low":n>=.7?"nsfw-high":n>=.3?"nsfw-medium":"nsfw-low"}updateFooter(){const n=this.panel.querySelector("#analyzedCount"),e=this.panel.querySelector("#totalCount"),t=this.images.filter(n=>"complete"===n.status).length;n&&(n.textContent=String(t)),e&&(e.textContent=String(this.images.length))}updateModelStatusUI(){if(!this.modelStatus)return;const n=this.panel.querySelector("#clipStatus"),e=this.panel.querySelector("#nsfwStatus"),t=this.panel.querySelector("#gpuStatus");n&&(n.className=`diffreal-model-badge ${this.modelStatus.clip}`,"loading"===this.modelStatus.clip?n.textContent=`CLIP ${this.modelStatus.clipProgress}%`:n.textContent="CLIP"),e&&(e.className=`diffreal-model-badge ${this.modelStatus.nsfw}`,"loading"===this.modelStatus.nsfw?e.textContent=`NSFW ${this.modelStatus.nsfwProgress}%`:e.textContent="NSFW"),t&&(t.textContent=this.modelStatus.gpuBackend.toUpperCase(),t.className="diffreal-model-badge ready")}onSettings(n){this.onSettingsChange=n}onScan(n){this.onScanRequest=n}onImageSelect(n){this.onImageClick=n}destroy(){this.container.remove()}}let i=0;function a(){return"diffreal-img-"+ ++i}async function s(n){return n.src.startsWith("data:")?n.src:new Promise((e,t)=>{const i=new Image;i.crossOrigin="anonymous",i.onload=()=>{try{const n=document.createElement("canvas");n.width=i.naturalWidth,n.height=i.naturalHeight;const a=n.getContext("2d");if(!a)return void t(new Error("Failed to get canvas context"));a.drawImage(i,0,0),e(n.toDataURL("image/jpeg",.9))}catch(n){t(n)}},i.onerror=()=>t(new Error("Failed to load image")),i.src=n.src})}console.log("[DiffReal] Content script loaded");let r=null,o={...n},l=[],d=!1,c=[];async function f(){r=new t,r.onSettings(h),r.onScan(g),r.onImageSelect(p),o=await chrome.runtime.sendMessage({type:"GET_SETTINGS"})||o,r.setSettings(o);const n=await chrome.runtime.sendMessage({type:"GET_MODEL_STATUS"});n&&r.setModelStatus(n),await chrome.runtime.sendMessage({type:"INIT_MODELS"}),new MutationObserver(u).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src","style","class"]})}function h(n){o={...o,...n},chrome.runtime.sendMessage({type:"UPDATE_SETTINGS",payload:n}),void 0===n.minWidth&&void 0===n.minHeight||g()}function g(){const n=function(n){const e=[],{minWidth:t,minHeight:i}=n,s=document.querySelectorAll("img");for(const n of s)if(n.naturalWidth>=t&&n.naturalHeight>=i){const t=n.src||n.currentSrc;t&&!t.startsWith("data:image/svg")&&e.push({id:a(),src:t,width:n.naturalWidth,height:n.naturalHeight,element:n,type:"img"})}const r=document.querySelectorAll("canvas");for(const n of r)if(n.width>=t&&n.height>=i)try{const t=n.toDataURL("image/png");e.push({id:a(),src:t,width:n.width,height:n.height,element:n,type:"canvas"})}catch{}return e}(o);l=n.map(n=>({...n,status:"pending"})),r?.setImages(l),l.length>0&&async function(){d||(d=!0,c=l.filter(n=>"pending"===n.status).map(n=>n.id),await async function(){for(;c.length>0;){const n=c.splice(0,5);await Promise.all(n.map(async n=>{const e=l.find(e=>e.id===n);if(e)try{e.status="analyzing",r?.updateImage(n,{status:"analyzing"});const t=await s(e),i=await chrome.runtime.sendMessage({type:"ANALYZE_IMAGE",payload:{imageId:n,imageData:t},target:"offscreen"});if(!i||"error"in i)throw new Error(i?.error||"Analysis failed");m(i)}catch(t){const i=t instanceof Error?t.message:"Unknown error";e.status="error",e.error=i,r?.updateImage(n,{status:"error",error:i})}})),c.length>0&&await new Promise(n=>setTimeout(n,100))}}(),d=!1)}()}function p(n){const e=l.find(e=>e.id===n);if(e?.element){!function(n){if(!n)return;n.scrollIntoView({behavior:"smooth",block:"center",inline:"center"});const e=n.style.outline,t=n.style.transition;n.style.transition="outline 0.3s ease",n.style.outline="4px solid #ff6b6b",setTimeout(()=>{n.style.outline=e,setTimeout(()=>{n.style.transition=t},300)},2e3)}(e.element);const t=document.querySelector(`[data-image-id="${n}"]`);t?.classList.add("highlight"),setTimeout(()=>t?.classList.remove("highlight"),2e3)}}function u(n){let e=!1;for(const t of n)if("childList"===t.type)for(const n of t.addedNodes){if(n instanceof HTMLImageElement){e=!0;break}if(n instanceof HTMLElement&&n.querySelector("img")){e=!0;break}}e&&o.autoAnalyze&&r?.isShown()&&setTimeout(()=>g(),500)}function m(n){const e=l.find(e=>e.id===n.imageId);e&&(e.status="complete",e.analysis=n,r?.updateImage(n.imageId,{status:"complete",analysis:n}))}chrome.runtime.onMessage.addListener((n,e,t)=>(async function(n){switch(n.type){case"TOGGLE_PANEL":const e=n.payload;return void 0!==e?.show?e.show?r?.show():r?.hide():r?.toggle(),r?.isShown();case"MODEL_PROGRESS":case"MODEL_STATUS":return void r?.setModelStatus(n.payload);case"UPDATE_SETTINGS":return o=n.payload,void r?.setSettings(o);case"ANALYSIS_RESULT":return void m(n.payload);default:return}}(n).then(t),!0)),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",f):f()})();