(()=>{"use strict";let e=null;async function a(){(await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[chrome.runtime.getURL("offscreen.html")]})).length>0||(e?await e:(e=chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.WORKERS],justification:"Run ML models for image analysis using WebGPU/WebGL"}),await e,e=null))}const t={minWidth:200,minHeight:200,realThreshold:.5,nsfwThreshold:.5,autoAnalyze:!0,showOverlay:!0},r="diffreal_settings";let n={...t},o=null;async function s(){const e=await chrome.storage.local.get(r);return e[r]&&(n={...t,...e[r]}),n}async function c(e){return await a(),chrome.runtime.sendMessage({...e,target:"offscreen"})}function i(e){return new Promise((a,t)=>{const r=new FileReader;r.onloadend=()=>a(r.result),r.onerror=t,r.readAsDataURL(e)})}async function l(e){const a=await chrome.tabs.query({});for(const t of a)t.id&&chrome.tabs.sendMessage(t.id,e).catch(()=>{})}console.log("[DiffReal] Background service worker started"),chrome.runtime.onInstalled.addListener(async()=>{console.log("[DiffReal] Extension installed"),await s(),await a(),chrome.runtime.sendMessage({type:"INIT_MODELS",target:"offscreen"}).catch(()=>{})}),chrome.runtime.onStartup.addListener(async()=>{console.log("[DiffReal] Browser started"),await s()}),chrome.runtime.onMessage.addListener((e,a,t)=>"offscreen"!==e.target&&(async function(e,a){switch(e.type){case"INIT_MODELS":case"ANALYZE_IMAGE":return c(e);case"GET_MODEL_STATUS":return o||c(e);case"MODEL_PROGRESS":return o=e.payload,void l(e);case"MODEL_STATUS":return o=e.payload,o;case"GET_SETTINGS":return n;case"UPDATE_SETTINGS":const t=await async function(e){return n={...n,...e},await chrome.storage.local.set({[r]:n}),n}(e.payload);return l({type:"UPDATE_SETTINGS",payload:t}),t;case"TOGGLE_PANEL":if(a.tab?.id)return chrome.tabs.sendMessage(a.tab.id,e);const[s]=await chrome.tabs.query({active:!0,currentWindow:!0});return s?.id?chrome.tabs.sendMessage(s.id,e):void 0;case"FETCH_IMAGE":return console.log("[DiffReal] Background: FETCH_IMAGE received"),async function(e){try{const a=await fetch(e);if(!a.ok)throw new Error(`HTTP ${a.status}`);const t=await a.blob();return{dataUrl:await i(t)}}catch(a){return console.error("[DiffReal] Failed to fetch image:",e,a),{dataUrl:null,error:a.message}}}(e.payload.url);case"CAPTURE_IMAGE":return console.log("[DiffReal] Background: CAPTURE_IMAGE received"),a.tab?.id?async function(e,a){try{const{rect:e,devicePixelRatio:r}=a,n=await chrome.tabs.captureVisibleTab({format:"png"}),o=await(t=n,new Promise((e,a)=>{fetch(t).then(e=>e.blob()).then(e=>createImageBitmap(e)).then(e).catch(a)})),s=Math.round(e.x*r),c=Math.round(e.y*r),l=Math.round(e.width*r),d=Math.round(e.height*r),u=new OffscreenCanvas(l,d),f=u.getContext("2d");if(!f)throw new Error("Failed to get canvas context");f.drawImage(o,s,c,l,d,0,0,l,d);const h=await u.convertToBlob({type:"image/jpeg",quality:.9});return{dataUrl:await i(h)}}catch(e){return console.error("[DiffReal] Failed to capture image:",e),{dataUrl:null,error:e.message}}var t}(a.tab.id,e.payload):{dataUrl:null,error:"No tab ID"};default:return void console.warn("[DiffReal] Unknown message type:",e.type)}}(e,a).then(t).catch(e=>{console.error("[DiffReal] Message handling error:",e),t({error:e.message})}),!0)),chrome.action.onClicked.addListener(async e=>{e.id&&await chrome.tabs.sendMessage(e.id,{type:"TOGGLE_PANEL"})})})();