(()=>{"use strict";let e=null;async function t(){(await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[chrome.runtime.getURL("offscreen.html")]})).length>0||(e?await e:(e=chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.WORKERS],justification:"Run ML models for image analysis using WebGPU/WebGL"}),await e,e=null))}const a={minWidth:512,minHeight:512,realThreshold:.5,nsfwThreshold:.5,autoAnalyze:!0,showOverlay:!0},n="diffreal_settings";let r={...a},s=null;async function o(){const e=await chrome.storage.local.get(n);return e[n]&&(r={...a,...e[n]}),r}async function c(e){return await t(),chrome.runtime.sendMessage({...e,target:"offscreen"})}async function i(e){const t=await chrome.tabs.query({});for(const a of t)a.id&&chrome.tabs.sendMessage(a.id,e).catch(()=>{})}console.log("[DiffReal] Background service worker started"),chrome.runtime.onInstalled.addListener(async()=>{console.log("[DiffReal] Extension installed"),await o(),await t(),chrome.runtime.sendMessage({type:"INIT_MODELS",target:"offscreen"}).catch(()=>{})}),chrome.runtime.onStartup.addListener(async()=>{console.log("[DiffReal] Browser started"),await o()}),chrome.runtime.onMessage.addListener((e,t,a)=>"offscreen"!==e.target&&(async function(e,t){switch(e.type){case"INIT_MODELS":case"ANALYZE_IMAGE":return c(e);case"GET_MODEL_STATUS":return s||c(e);case"MODEL_PROGRESS":return s=e.payload,void i(e);case"MODEL_STATUS":return s=e.payload,s;case"GET_SETTINGS":return r;case"UPDATE_SETTINGS":const a=await async function(e){return r={...r,...e},await chrome.storage.local.set({[n]:r}),r}(e.payload);return i({type:"UPDATE_SETTINGS",payload:a}),a;case"TOGGLE_PANEL":if(t.tab?.id)return chrome.tabs.sendMessage(t.tab.id,e);const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});return o?.id?chrome.tabs.sendMessage(o.id,e):void 0;default:return void console.warn("[DiffReal] Unknown message type:",e.type)}}(e,t).then(a).catch(e=>{console.error("[DiffReal] Message handling error:",e),a({error:e.message})}),!0)),chrome.action.onClicked.addListener(async e=>{e.id&&await chrome.tabs.sendMessage(e.id,{type:"TOGGLE_PANEL"})})})();